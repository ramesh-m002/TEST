<?php

/**
 * Plugin Name:       FS-CSP-NONCE
 * Plugin URI:        https://tsw.ovh/
 * Description:       Add a nonce to each script and style tag, and set those nonces in CSP header
 * Version:           1.5.2
 * Requires at least: 5.9
 * Requires PHP:      7.3
 * Author:            flightsafety
 * License:           GPL v3
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Generate and store a nonce for the current request.
 */
function dynamic_csp_generate_nonce() {
	static $nonce = null;

	if ( $nonce === null ) {
		$nonce = base64_encode( random_bytes(16) );
	}

	return $nonce;
}

/**
 * Add nonce attribute to all enqueued <script> tags.
 */
add_filter( 'script_loader_tag', function ( $tag, $handle, $src ) {
	$nonce = dynamic_csp_generate_nonce();
	return str_replace( ' src', ' nonce="' . esc_attr( $nonce ) . '" src', $tag );
}, 10, 3 );

/**
 * Add nonce attribute to all enqueued <style> tags.
 */
add_filter( 'style_loader_tag', function ( $tag, $handle, $href, $media ) {
	$nonce = dynamic_csp_generate_nonce();
	return str_replace( ' href', ' nonce="' . esc_attr( $nonce ) . '" href', $tag );
}, 10, 4 );

/**
 * Dynamically add the Content Security Policy header.
 *
 * This version has no hardcoded external domains.
 * You can safely extend it later by filtering 'dynamic_csp_policy'.
 */
add_action( 'send_headers', function () {
	$nonce = dynamic_csp_generate_nonce();

	// Define a minimal, restrictive policy
	$policy = [
		"default-src 'self'",
		"script-src 'self' 'nonce-{$nonce}'",
		"style-src 'self' 'nonce-{$nonce}'",
		"font-src 'self' data:",
		"img-src 'self' data:",
		"connect-src 'self'",
		"object-src 'none'",
		"base-uri 'self'",
		"form-action 'self'"
	];

	// Allow developers to modify the policy dynamically via filter
	$policy = apply_filters( 'dynamic_csp_policy', $policy, $nonce );

	header( 'Content-Security-Policy: ' . implode( '; ', $policy ) );
});
